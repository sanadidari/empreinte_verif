name: Auto Guardian ‚Äî Project Integrity Shield

on:
  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
  guardian:
    name: Integrity Checkpoint
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      ###############################################################
      # 1) CHECK CRITICAL DOCUMENTATION
      ###############################################################
      - name: Check critical documentation exists
        run: |
          FILES=(
            docs/AGENT_START.md
            docs/DOCS_MANIFEST.yaml
            docs/NEXT_ACTION.md
            docs/TASKS.md
            docs/STATE_PROJECT.md
            docs/AGENT_PROTOCOL.md
            docs/CHECKLIST_MASTER.md
          )

          for F in "${FILES[@]}"; do
            if [ ! -f "$F" ]; then
              echo "ERROR: Missing critical file: $F"
              echo "guardian_error=true" >> $GITHUB_OUTPUT
              exit 20
            fi
          done

      ###############################################################
      # 2) CHECK WORKFLOWS EXIST
      ###############################################################
      - name: Verify mandatory workflows
        run: |
          WF=(
            auto_deploy_flutter_web.yml
            auto_doc_update.yml
            auto_sync_mirror.yml
            auto_lint_fix.yml
            agent_trigger.yml
            agent_heartbeat.yml
            healthcheck.yml
            rollback.yml
            post_deploy_tests.yml
          )

          for W in "${WF[@]}"; do
            if [ ! -f ".github/workflows/$W" ]; then
              echo "ERROR: Missing workflow: $W"
              exit 30
            fi
          done

      ###############################################################
      # 3) SAFETY CHECK ‚Äî FILES THAT MUST NOT CHANGE
      ###############################################################
      - name: Validate protected files integrity
        run: |
          PROTECTED=(
            docs/AGENT_START.md
            docs/AGENT_PROTOCOL.md
            docs/CHECKLIST_MASTER.md
          )

          for P in "${PROTECTED[@]}"; do
            if ! git diff --name-only HEAD~1 | grep -q "$P"; then
              continue
            fi

            echo "‚ö†Ô∏è WARNING: Protected file modified: $P"
            echo "guardian_warning=true" >> $GITHUB_OUTPUT
          done

      ###############################################################
      # 4) RUN FLUTTER ANALYZE (NO FAIL, ONLY DIAG)
      ###############################################################
      - name: Set up Flutter
        uses: subosito/flutter-action@v2

      - name: Flutter analyze
        continue-on-error: true
        run: |
          flutter pub get
          dart analyze > flutter_analyze.txt || true

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: flutter-analyze-results
          path: flutter_analyze.txt

      ###############################################################
      # 5) FINAL DECISION ‚Äî BLOCK OR PASS
      ###############################################################
      - name: Final decision
        run: |
          if [ "$guardian_error" = "true" ]; then
            echo "‚ùå BLOCKED: Integrity violation detected."
            exit 50
          fi

          if [ "$guardian_warning" = "true" ]; then
            echo "‚ö†Ô∏è WARNING: Changes detected in protected files."
            exit 0
          fi

          echo "‚úî Guardian: All checks passed."

      ###############################################################
      # 6) Report into PR
      ###############################################################
      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: "üõ°Ô∏è Auto Guardian completed.\nIntegrity verified.\nWarnings/errors generated if applicable."
            })
