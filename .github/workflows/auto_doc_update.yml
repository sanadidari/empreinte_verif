name: Auto Update Documentation — Machine Sync

on:
  push:
    branches:
      - main
    paths:
      - "lib/**"
      - "web/**"
      - "pubspec.yaml"
      - ".github/workflows/**"

  workflow_dispatch:

jobs:
  auto_doc_update:
    name: Synchronize documentation with project state
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install YQ for YAML parsing
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq yq

      - name: Analyze project structure
        run: |
          echo "Analyzing project structure..."
          STRUCT_OK=true

          if [ ! -f "pubspec.yaml" ]; then STRUCT_OK=false; fi
          if [ ! -d "lib" ]; then STRUCT_OK=false; fi
          if [ ! -d "web" ]; then STRUCT_OK=false; fi

          echo "structure_ok: $STRUCT_OK" | tee structure_check.txt

      - name: Regenerate STATE_PROJECT.md (machine)
        run: |
          echo "Updating STATE_PROJECT.md ..."
          cat << 'EOF' > docs/STATE_PROJECT.md
# STATE_PROJECT.md — AUTO-GENERATED MACHINE STATE
generated_by: auto_doc_update
last_update: $(date)

flutter:
  sdk: stable
  web_support: true

directories:
  lib: $(ls lib | wc -l) files
  web: $(ls web | wc -l) files
  workflows: $(ls .github/workflows | wc -l) workflows

critical_files:
  - pubspec.yaml
  - web/index.html
  - web/main.dart.js (generated after build)

sync_status:
  last_commit: $(git rev-parse HEAD)

END_OF_FILE
EOF

      - name: Regenerate DOCUMENTATION_REPORT.md
        run: |
          cat << 'EOF' > docs/DOCUMENTATION_REPORT.md
# DOCUMENTATION_REPORT.md — AUTO UPDATE
Generated by: auto_doc_update workflow
Timestamp: $(date)

## Structure Check
$(cat structure_check.txt)

## Last Commit
$(git rev-parse HEAD)

EOF

      - name: Commit documentation updates
        run: |
          git config --local user.email "auto-doc@system.local"
          git config --local user.name "Auto Documentation Bot"

          git add docs/STATE_PROJECT.md
          git add docs/DOCUMENTATION_REPORT.md || true

          if git diff --cached --quiet; then
            echo "No documentation updates needed."
            exit 0
          fi

          git commit -m "docs: auto-update documentation based on project state"
          git push origin HEAD:docs/auto-doc-update

      - name: Create automatic pull request
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          branch: docs/auto-doc-update
          title: "Auto Documentation Update"
          body: "Automated update of machine-readable documentation."
          labels: "automation, documentation"
